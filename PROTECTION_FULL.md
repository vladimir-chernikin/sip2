# üîí –ü–û–õ–ù–ê–Ø –ó–ê–©–ò–¢–ê ASTERISK –û–¢ –ë–†–£–¢–§–û–†–°–ê

## ‚úÖ –ù–∞—Å—Ç—Ä–æ–µ–Ω–æ –∏ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–æ:

### 1. FAIL2BAN - –û–°–ù–û–í–ù–ê–Ø –ó–ê–©–ò–¢–ê

#### `/etc/fail2ban/jail.d/asterisk-sip.conf`
- **–ë–∞–Ω –ø–æ—Å–ª–µ:** 3 –Ω–µ—É–¥–∞—á–Ω—ã—Ö –ø–æ–ø—ã—Ç–æ–∫
- **–í —Ç–µ—á–µ–Ω–∏–µ:** 15 —Å–µ–∫—É–Ω–¥
- **–ë–∞–Ω –Ω–∞:** 30 –¥–Ω–µ–π (2592000 —Å–µ–∫)
- **–î–µ–π—Å—Ç–≤–∏–µ:** iptables-allports (–±–ª–æ–∫–∏—Ä—É–µ—Ç –í–°–ï –ø–æ—Ä—Ç—ã)

#### `/etc/fail2ban/filter.d/asterisk-sip.conf`
- –§–∏–ª—å—Ç—Ä—É–µ—Ç: Failed to authenticate, No matching endpoint found

#### `/etc/fail2ban/jail.d/recidive.local` (—Ä–µ—Ü–∏–¥–∏–≤–∏—Å—Ç—ã)
- **–ë–∞–Ω –ø–æ—Å–ª–µ:** 3 –±–∞–Ω–æ–≤
- **–í —Ç–µ—á–µ–Ω–∏–µ:** 1 –¥–µ–Ω—å
- **–ë–∞–Ω –Ω–∞:** 90 –¥–Ω–µ–π

---

### 2. –õ–û–ì–ò–†–û–í–ê–ù–ò–ï –î–õ–Ø FAIL2BAN

#### `/usr/local/bin/docker-log-asterisk.sh`
- –ú–æ–Ω–∏—Ç–æ—Ä–∏—Ç `docker logs -f asterisk`
- –ü–∏—à–µ—Ç –≤ `/var/log/docker/asterisk.log`
- –†–æ—Ç–∞—Ü–∏—è –ø—Ä–∏ 50MB ‚Üí —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç 10,000 —Å—Ç—Ä–æ–∫
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ—Ç fail2ban –ø–æ—Å–ª–µ —Ä–æ—Ç–∞—Ü–∏–∏
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –ø—Ä–∏ –ø–µ—Ä–µ—Å–æ–∑–¥–∞–Ω–∏–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞

#### `/etc/systemd/system/docker-log-asterisk.service`
- Systemd —Å–µ—Ä–≤–∏—Å —Å –∞–≤—Ç–æ–∑–∞–ø—É—Å–∫–æ–º
- –ê–≤—Ç–æ—Å—Ç–∞—Ä—Ç –ø–æ—Å–ª–µ docker.service

---

### 3. –†–û–¢–ê–¶–ò–Ø –õ–û–ì–û–í ASTERISK

#### `/usr/local/bin/asterisk-log-rotator.sh`
- –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –∫–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç
- –†–æ—Ç–∏—Ä—É–µ—Ç `messages.log` –ø—Ä–∏ 100MB
- –£–¥–∞–ª—è–µ—Ç `messages.log.*` —Å—Ç–∞—Ä—à–µ 7 –¥–Ω–µ–π
- –£–¥–∞–ª—è–µ—Ç `queue_log.*` —Å—Ç–∞—Ä—à–µ 3 –¥–Ω–µ–π

#### `/etc/systemd/system/asterisk-log-rotator.service`
- Systemd —Å–µ—Ä–≤–∏—Å —Å –∞–≤—Ç–æ–∑–∞–ø—É—Å–∫–æ–º

#### `/etc/logrotate.d/docker-asterisk`
```
/var/log/docker/asterisk.log {
    daily, rotate 3, compress, maxsize 10M
}
```

---

### 4. –°–ò–°–¢–ï–ú–ù–´–ô –ú–û–ù–ò–¢–û–†–ò–ù–ì

#### `/usr/local/bin/system-monitor.sh`
–ó–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –∫–∞–∂–¥—ã–µ 10 –º–∏–Ω—É—Ç —á–µ—Ä–µ–∑ cron:

–ü—Ä–æ–≤–µ—Ä—è–µ—Ç:
- –î–∏—Å–∫ (–ø–æ—Ä–æ–≥ 90%)
- CPU (–ø–æ—Ä–æ–≥ 90%)
- RAM (–ø–æ—Ä–æ–≥ 90%)
- –ü–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω—ã–µ –ø—Ä–æ—Ü–µ—Å—Å—ã (>50% CPU –∏–ª–∏ >10% RAM)
- Docker –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –±–µ–∑ –ª–∏–º–∏—Ç–æ–≤ –ø–∞–º—è—Ç–∏
- OOM —Å–æ–±—ã—Ç–∏—è –≤ journalctl

–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –¥–µ–π—Å—Ç–≤–∏—è:
- –û—á–∏—Å—Ç–∫–∞ Docker –ª–æ–≥–æ–≤ –ø—Ä–∏ >100MB
- –û—á–∏—Å—Ç–∫–∞ Docker build cache
- –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ —Ç—è–∂—ë–ª—ã—Ö –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ –ø—Ä–∏ RAM>95%

---

### 5. DOCKER –ù–ê–°–¢–†–û–ô–ö–ò

#### `/asterisk/docker-compose.yml`

**–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è —Ä–µ—Å—É—Ä—Å–æ–≤:**
- `asterisk`: 0.5 CPU, 512MB RAM
- `backend`: 0.5 CPU, 512MB RAM
- `audiosocket`: 1.0 CPU, 1GB RAM

**–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ:**
- –î—Ä–∞–π–≤–µ—Ä: json-file
- max-size: 10m
- max-file: 3

---

### 6. CRON –ó–ê–î–ê–ß–ò

```bash
0 3 * * 0 root docker system prune -f --volumes
*/10 * * * * root /usr/local/bin/system-monitor.sh
```

---

## üìã –£–ü–†–ê–í–õ–ï–ù–ò–ï –ó–ê–©–ò–¢–û–ô

### –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤:
```bash
# Fail2ban jails
fail2ban-client status

# –î–µ—Ç–∞–ª—å–Ω—ã–π —Å—Ç–∞—Ç—É—Å asterisk-sip
fail2ban-client status asterisk-sip

# –°–µ—Ä–≤–∏—Å—ã –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
systemctl status docker-log-asterisk.service
systemctl status asterisk-log-rotator.service
```

### –õ–æ–≥–∏:
```bash
# –õ–æ–≥–∏ Docker Asterisk
tail -f /var/log/docker/asterisk.log

# –õ–æ–≥–∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
journalctl -u docker-log-asterisk -f
journalctl -u asterisk-log-rotator -f

# –õ–æ–≥–∏ fail2ban
tail -f /var/log/fail2ban.log

# –°–∏—Å—Ç–µ–º–Ω—ã–π –º–æ–Ω–∏—Ç–æ—Ä
tail -f /var/log/system-monitor.log
```

### –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ IP:
```bash
# –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ
fail2ban-client status asterisk-sip

# –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –ø—Ä–∞–≤–∏–ª–∞ iptables
iptables -L -n | grep DROP

# –†–∞–∑–±–∞–Ω–∏—Ç—å IP
fail2ban-client set asterisk-sip unbanip IP_ADDRESS
```

### –†—É—á–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:
```bash
# –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å fail2ban
systemctl restart fail2ban

# –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ª–æ–≥–æ–≤
systemctl restart docker-log-asterisk.service

# –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å —Ä–æ—Ç–∞—Ü–∏—é –ª–æ–≥–æ–≤
systemctl restart asterisk-log-rotator.service
```

---

## üö® –ê–õ–ï–†–¢–´ –ò –£–í–ï–î–û–ú–õ–ï–ù–ò–Ø

–°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏:
1. **–ë–∞–Ω–∏—Ç IP** –ø–æ—Å–ª–µ 3 –Ω–µ—É–¥–∞—á–Ω—ã—Ö –ø–æ–ø—ã—Ç–æ–∫ –∑–∞ 15 —Å–µ–∫—É–Ω–¥
2. **–ë–∞–Ω–∏—Ç —Ä–µ—Ü–∏–¥–∏–≤–∏—Å—Ç–æ–≤** –Ω–∞ 90 –¥–Ω–µ–π
3. **–†–æ—Ç–∏—Ä—É–µ—Ç –ª–æ–≥–∏** –ø—Ä–∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–∏ –ª–∏–º–∏—Ç–æ–≤
4. **–û—á–∏—â–∞–µ—Ç –¥–∏—Å–∫** –ø—Ä–∏ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏–∏ >90%
5. **–ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ—Ç –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã** –ø—Ä–∏ –ø–µ—Ä–µ–≥—Ä—É–∑–∫–µ RAM

---

## üìä –¢–ï–ö–£–©–ò–ô –°–¢–ê–¢–£–°

| –ö–æ–º–ø–æ–Ω–µ–Ω—Ç | –°—Ç–∞—Ç—É—Å | –û–ø–∏—Å–∞–Ω–∏–µ |
|-----------|--------|----------|
| **Fail2ban** | ‚úÖ –ê–∫—Ç–∏–≤–µ–Ω | Jails: asterisk-sip, recidive, sshd |
| **Docker Log Monitor** | ‚úÖ –ê–∫—Ç–∏–≤–µ–Ω | –ü–∏—à–µ—Ç –≤ /var/log/docker/asterisk.log |
| **Log Rotator** | ‚úÖ –ê–∫—Ç–∏–≤–µ–Ω | –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –∫–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç |
| **System Monitor** | ‚úÖ –ù–∞—Å—Ç—Ä–æ–µ–Ω | Cron –∫–∞–∂–¥—ã–µ 10 –º–∏–Ω—É—Ç |
| **IPTables** | ‚úÖ –ê–∫—Ç–∏–≤–µ–Ω | Rate limit 5060: 10/—Å–µ–∫ |

---

## ‚ö†Ô∏è –í–ê–ñ–ù–´–ï –ó–ê–ú–ï–ß–ê–ù–ò–Ø

1. **–°–º–µ–Ω–∏—Ç–µ –ø–∞—Ä–æ–ª—å SIP –∞–∫–∫–∞—É–Ω—Ç–∞** —Å `1001pass` –Ω–∞ —Å–ª–æ–∂–Ω—ã–π!
2. **–°–ª–µ–¥–∏—Ç–µ –∑–∞ –ª–æ–≥–∞–º–∏** –ø—Ä–∏ –ø–µ—Ä–≤—ã—Ö –∑–∞–ø—É—Å–∫–∞—Ö
3. **–†–µ–≥—É–ª—è—Ä–Ω–æ –ø—Ä–æ–≤–µ—Ä—è–π—Ç–µ** –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ IP
4. **–¢–µ—Å—Ç–∏—Ä—É–π—Ç–µ** —Å–∏—Å—Ç–µ–º—É –∑–∞—â–∏—Ç—ã –ø–µ—Ä–µ–¥ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–æ–º

---

## üîß –ü–†–û–í–ï–†–ö–ê –†–ê–ë–û–¢–´

### –¢–µ—Å—Ç –±–∞–Ω–∞ (–æ—Å—Ç–æ—Ä–æ–∂–Ω–æ!):
```bash
# –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è —Å –Ω–µ–≤–µ—Ä–Ω—ã–º –ø–∞—Ä–æ–ª–µ–º 3 —Ä–∞–∑–∞
# IP –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∑–∞–±–∞–Ω–µ–Ω –Ω–∞ 30 –¥–Ω–µ–π

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –±–∞–Ω
fail2ban-client status asterisk-sip
```

### –†–∞–∑–±–∞–Ω:
```bash
# –†–∞–∑–±–∞–Ω–∏—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–π IP
fail2ban-client set asterisk-sip unbanip YOUR_IP
```

